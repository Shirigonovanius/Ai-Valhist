<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompt Battle ‚Äî Judge Panel</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* –°–ø–µ—Ü-—Å—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ */
    body { background: #0b0f19; color: #e5e7eb; padding: 20px; }
    .admin-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: calc(100vh - 100px); }
    
    .sidebar { background: #111827; border-radius: 12px; padding: 10px; overflow-y: auto; border: 1px solid #374151; }
    .battle-item { padding: 10px; border-bottom: 1px solid #1f2937; cursor: pointer; transition: 0.2s; }
    .battle-item:hover { background: #1f2937; }
    .battle-item.active { background: #374151; border-left: 3px solid #6366f1; }
    
    .main-area { background: #111827; border-radius: 12px; padding: 20px; border: 1px solid #374151; display: flex; flex-direction: column; }
    
    .images-row { display: flex; gap: 20px; justify-content: center; margin-top: 20px; }
    .img-box { width: 45%; background: #000; border-radius: 8px; overflow: hidden; position: relative; border: 2px solid transparent; }
    .img-box img { width: 100%; display: block; min-height: 200px; background: #222; }
    .img-box h3 { position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); margin: 0; padding: 5px; text-align: center; font-size: 14px; }
    
    .winner-btn { width: 100%; margin-top: 10px; padding: 12px; font-weight: bold; cursor: pointer; border: none; }
    .btn-p1 { background: #6366f1; color: white; }
    .btn-p1:hover { background: #4f46e5; }
    .btn-p2 { background: #ec4899; color: white; }
    .btn-p2:hover { background: #db2777; }

    .status-bar { margin-bottom: 15px; padding: 10px; background: #1f2937; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

  <div class="status-bar">
    <div>
      <h2 style="margin:0">Judge Panel</h2>
      <small id="adminStatus">Waiting for input...</small>
    </div>
    <div style="text-align: right;">
      <button id="connectWalletBtn" class="btn">Connect Admin Wallet</button>
      <div id="walletAddr" style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Not connected</div>
    </div>
  </div>

  <div class="admin-grid">
    <div class="sidebar" id="battleList">
      <div style="padding:10px; color:#6b7280; text-align:center;">Loading battles...</div>
    </div>

    <div class="main-area" id="detailView" style="display:none;">
      <div style="display:flex; justify-content:space-between;">
        <h2 id="battleTitle">Battle #...</h2>
        <div class="badge" id="battleStatus">STATUS</div>
      </div>
      
      <div style="margin-bottom: 10px; color: #9ca3af; font-family: monospace;">
        Stake: <span id="stakeVal">0</span> USDC | Theme: <span id="battleTheme" style="color:#fff">...</span>
      </div>

      <div class="images-row">
        <div class="img-box" id="box1">
          <h3 style="color: #a5b4fc">Player 1</h3>
          <img id="img1" src="">
          <div style="padding: 10px;">
            <div style="font-size: 11px; color: #ccc; margin-bottom: 5px;">Addr: <span id="addr1">...</span></div>
            <button class="winner-btn btn-p1" onclick="judgeWinner(1)">üèÜ P1 WINS</button>
          </div>
        </div>

        <div class="img-box" id="box2">
          <h3 style="color: #f9a8d4">Player 2</h3>
          <img id="img2" src="">
          <div style="padding: 10px;">
            <div style="font-size: 11px; color: #ccc; margin-bottom: 5px;">Addr: <span id="addr2">...</span></div>
            <button class="winner-btn btn-p2" onclick="judgeWinner(2)">üèÜ P2 WINS</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  
  <script>
    const ESCROW_ABI = [
      'function closeBattle(uint256 battleId, address winner) external'
    ];
    
    let state = {
      battles: [],
      currentId: null,
      provider: null,
      signer: null,
      adminAddr: null,
      escrowAddress: null 
    };

    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
    async function loadConfig() {
      const res = await fetch('/api/config');
      const cfg = await res.json();
      state.escrowAddress = cfg.contracts.escrow;
    }

    // 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
    async function connectWallet() {
      if (!window.ethereum) return alert('No wallet');
      const provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = await provider.getSigner();
      const addr = await signer.getAddress();
      
      state.provider = provider;
      state.signer = signer;
      state.adminAddr = addr;
      
      document.getElementById('walletAddr').textContent = addr;
      document.getElementById('connectWalletBtn').style.display = 'none';
    }
    document.getElementById('connectWalletBtn').onclick = connectWallet;

    // 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –±–∏—Ç–≤
    async function loadBattles() {
      // !!! –ò–°–ü–†–ê–í–õ–ï–ù–û: –°—Ç—É—á–∏–º—Å—è –≤ –∞–¥–º–∏–Ω–∫—É (/api/admin/battles), –∞ –Ω–µ –≤ –≥–∞–ª–µ—Ä–µ—é !!!
      const res = await fetch('/api/admin/battles');
      const data = await res.json();
      
      const listEl = document.getElementById('battleList');
      listEl.innerHTML = '';

      if (!data.ok || !data.items) {
          listEl.innerHTML = '<div style="padding:10px; color:red">Error loading</div>';
          return;
      }

      state.battles = data.items; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï (–¥–∞–∂–µ —Å–ª–æ–º–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Ö)

      if (state.battles.length === 0) {
        listEl.innerHTML = '<div style="padding:10px">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∏—Ç–≤.</div>';
        return;
      }

      state.battles.forEach(b => {
        const div = document.createElement('div');
        div.className = 'battle-item';
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        let color = '#fff';
        if(b.gen_status === 'done') color = '#10b981'; // –ó–µ–ª–µ–Ω—ã–π
        if(b.gen_status === 'running') color = '#fbbf24'; // –ñ–µ–ª—Ç—ã–π
        if(b.gen_status === 'error') color = '#ef4444'; // –ö—Ä–∞—Å–Ω—ã–π

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <b>#${b.id}</b> 
                <span style="color:${color}; font-size:10px">${b.gen_status}</span>
            </div>
            <small style="color:#9ca3af">${b.theme}</small>
        `;
        div.onclick = () => openBattle(b.id);
        listEl.appendChild(div);
      });
    }

    // 4. –û—Ç–∫—Ä—ã—Ç–∏–µ –±–∏—Ç–≤—ã
    async function openBattle(id) {
      state.currentId = id;
      
      // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ (—á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å)
      const b = state.battles.find(x => x.id === id);
      if(!b) return;

      document.getElementById('detailView').style.display = 'block';
      document.getElementById('battleTitle').textContent = `Battle #${b.id}`;
      document.getElementById('battleStatus').textContent = b.status;
      document.getElementById('stakeVal').textContent = b.stake;
      document.getElementById('battleTheme').textContent = b.theme;

      document.getElementById('img1').src = b.p1_image_url || 'https://via.placeholder.com/400?text=Wait...';
      document.getElementById('img2').src = b.p2_image_url || 'https://via.placeholder.com/400?text=Wait...';
      
      document.getElementById('addr1').textContent = b.player1;
      document.getElementById('addr2').textContent = b.player2;

      document.getElementById('box1').dataset.addr = b.player1;
      document.getElementById('box2').dataset.addr = b.player2;
    }

    // 5. –í–´–ë–û–† –ü–û–ë–ï–î–ò–¢–ï–õ–Ø
    async function judgeWinner(playerNum) {
      if (!state.signer) return alert('–ü–æ–¥–∫–ª—é—á–∏ –∞–¥–º–∏–Ω—Å–∫–∏–π –∫–æ—à–µ–ª–µ–∫!');
      const bId = state.currentId;
      const winnerAddr = document.getElementById(`box${playerNum}`).dataset.addr;

      if (!confirm(`–ü—Ä–∏—Å—É–¥–∏—Ç—å –ø–æ–±–µ–¥—É –∏–≥—Ä–æ–∫—É ${playerNum}?\n${winnerAddr}`)) return;

      const statusEl = document.getElementById('adminStatus');
      
      try {
        // A. –ë–ª–æ–∫—á–µ–π–Ω
        statusEl.textContent = '‚è≥ MetaMask: –ü–æ–¥–ø–∏—à–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é...';
        
        const escrowContract = new ethers.Contract(state.escrowAddress, ESCROW_ABI, state.signer);
        const tx = await escrowContract.closeBattle(bId, winnerAddr);
        
        statusEl.textContent = '‚è≥ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –∂–¥–µ–º...';
        await tx.wait();
        
        statusEl.textContent = '‚úÖ –í—ã–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞!';

        // B. API
        const apiRes = await fetch(`/api/battles/${bId}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ winner: winnerAddr })
        });
        
        const apiJson = await apiRes.json();
        if (apiJson.ok) {
           alert('–ì–æ—Ç–æ–≤–æ! –ë–∏—Ç–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
           loadBattles();
           document.getElementById('detailView').style.display = 'none';
        } else {
           alert('–û—à–∏–±–∫–∞ API: ' + apiJson.error);
        }

      } catch (e) {
        console.error(e);
        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞';
        alert('–û—à–∏–±–∫–∞: ' + (e.reason || e.message));
      }
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
        loadConfig();
        loadBattles();
        setInterval(loadBattles, 5000); // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    });

  </script>
</body>
</html>